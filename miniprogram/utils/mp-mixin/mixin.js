"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports._globalMixin = exports._mixinGlobal = exports.mixinCurrent = exports.mixinData = void 0;
var store_1 = require("./store");
var util_1 = require("./util");
var globalMixins;
var pageLifeTimeNames = [
    'onLoad',
    'onShow',
    'onReady',
    'onHide',
    'onShow',
    'onUnload',
    'onPullDownRefresh',
    'onReachBottom',
    'onShareAppMessage',
    'onShareTimeline',
    'onAddToFavorites',
    'onPageScroll',
    'onResize',
    'onTabItemTap',
];
function mixinData(options, data) {
    if (typeof data === 'undefined' || typeof options.data === 'undefined')
        return;
    util_1.mapToTarget({
        data: data,
        target: options.data
    });
}
exports.mixinData = mixinData;
function mixinMethods(options, methods, type) {
    if (type === void 0) { type = 0; }
    if (!methods)
        return;
    var isComponent = type === 1;
    if (isComponent && !options.methods) {
        options.methods = {};
    }
    util_1.mapToTarget({
        data: methods,
        target: isComponent ?
            options.methods :
            options
    });
}
function mixinLifeTimes(options, mixin) {
    var leftTimes = util_1.pick(mixin, pageLifeTimeNames);
    util_1.mapToTarget({
        data: leftTimes,
        target: options
    });
    markUnload(options);
}
function markUnload(leftTimes, type) {
    if (type === void 0) { type = 0; }
    var markUnloadFlag = function () {
        this.__unload = true;
    };
    var name = type === 0 ? 'onUnload' : 'detached';
    if (leftTimes[name]) {
        var nativeMethod_1 = leftTimes[name];
        leftTimes[name] = function () {
            nativeMethod_1.call(this);
            markUnloadFlag.call(this);
        };
    }
    else {
        leftTimes[name] = markUnloadFlag;
    }
}
function mixinComponentLifeTimes(options, mixin) {
    var leftTimes = mixin.lifetimes;
    if (!options.lifetimes) {
        options.lifetimes = {};
    }
    if (leftTimes) {
        util_1.mapToTarget({
            data: leftTimes,
            target: options.lifetimes
        });
    }
    markUnload(options.lifetimes, 1);
    var pageLiftTimes = mixin.pageLifetimes;
    if (pageLiftTimes) {
        if (!options.pageLifetimes) {
            options.pageLifetimes = {};
        }
        util_1.mapToTarget({
            data: pageLiftTimes,
            target: options.pageLifetimes
        });
    }
}
function mixinCurrent(_a) {
    var options = _a.options, mixin = _a.mixin, _b = _a.global, global = _b === void 0 ? false : _b, _c = _a.type, type = _c === void 0 ? 0 : _c, storeTool = _a.storeTool;
    if (typeof mixin === 'undefined') {
        mixin = options.mixin;
    }
    if (typeof mixin === 'undefined') {
        return options;
    }
    mixin = util_1.deepClone(mixin);
    if (type === 0) {
        mixinLifeTimes(options, mixin);
    }
    else if (type === 1) {
        mixinComponentLifeTimes(options, mixin);
    }
    mixinData(options, mixin.data);
    mixinMethods(options, mixin.methods, type);
    store_1.injectStore({ options: options, mixinStore: mixin.store, global: global, storeTool: storeTool });
    return options;
}
exports.mixinCurrent = mixinCurrent;
function _mixinGlobal(_a) {
    var options = _a.options, type = _a.type, storeTool = _a.storeTool;
    return mixinCurrent({
        options: options,
        mixin: globalMixins,
        global: true,
        type: type,
        storeTool: storeTool
    });
}
exports._mixinGlobal = _mixinGlobal;
function _globalMixin(mixin) {
    globalMixins = mixin;
    store_1.checkGlobalMixinStore(mixin.store);
}
exports._globalMixin = _globalMixin;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWl4aW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJtaXhpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFVQSxpQ0FBMkQ7QUFFM0QsK0JBQW9EO0FBRXBELElBQUksWUFBMEIsQ0FBQztBQUUvQixJQUFNLGlCQUFpQixHQUFHO0lBQ3RCLFFBQVE7SUFDUixRQUFRO0lBQ1IsU0FBUztJQUNULFFBQVE7SUFDUixRQUFRO0lBQ1IsVUFBVTtJQUVWLG1CQUFtQjtJQUNuQixlQUFlO0lBQ2YsbUJBQW1CO0lBQ25CLGlCQUFpQjtJQUNqQixrQkFBa0I7SUFDbEIsY0FBYztJQUNkLFVBQVU7SUFDVixjQUFjO0NBQ2pCLENBQUM7QUFFRixTQUFnQixTQUFTLENBQUUsT0FBb0IsRUFBRSxJQUFZO0lBQ3pELElBQUksT0FBTyxJQUFJLEtBQUssV0FBVyxJQUFJLE9BQU8sT0FBTyxDQUFDLElBQUksS0FBSyxXQUFXO1FBQUUsT0FBTztJQUMvRSxrQkFBVyxDQUFDO1FBQ1IsSUFBSSxNQUFBO1FBQ0osTUFBTSxFQUFFLE9BQU8sQ0FBQyxJQUFJO0tBQ3ZCLENBQUMsQ0FBQztBQUNQLENBQUM7QUFORCw4QkFNQztBQUVELFNBQVMsWUFBWSxDQUNqQixPQUF1QyxFQUN2QyxPQUF5QixFQUN6QixJQUFvQztJQUFwQyxxQkFBQSxFQUFBLFFBQW9DO0lBRXBDLElBQUksQ0FBQyxPQUFPO1FBQUUsT0FBTztJQUNyQixJQUFNLFdBQVcsR0FBRyxJQUFJLE1BQTBCLENBQUM7SUFDbkQsSUFBSSxXQUFXLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFO1FBQ2pDLE9BQU8sQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO0tBQ3hCO0lBQ0Qsa0JBQVcsQ0FBQztRQUNSLElBQUksRUFBRSxPQUFPO1FBQ2IsTUFBTSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1lBQ2hCLE9BQTRCLENBQUMsT0FBMEIsQ0FBQyxDQUFDO1lBQzFELE9BQU87S0FDZCxDQUFDLENBQUM7QUFD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QUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztJQUUzQyxtQkFBVyxDQUFDLEVBQUMsT0FBTyxTQUFBLEVBQUUsVUFBVSxFQUFFLEtBQUssQ0FBQyxLQUFLLEVBQUUsTUFBTSxRQUFBLEVBQUUsU0FBUyxXQUFBLEVBQUMsQ0FBQyxDQUFDO0lBRW5FLE9BQU8sT0FBTyxDQUFDO0FBQ25CLENBQUM7QUFqQ0Qsb0NBaUNDO0FBRUQsU0FBZ0IsWUFBWSxDQUFFLEVBUTdCO1FBUEcsT0FBTyxhQUFBLEVBQ1AsSUFBSSxVQUFBLEVBQ0osU0FBUyxlQUFBO0lBTVQsT0FBTyxZQUFZLENBQUM7UUFDaEIsT0FBTyxTQUFBO1FBQ1AsS0FBSyxFQUFFLFlBQVk7UUFDbkIsTUFBTSxFQUFFLElBQUk7UUFDWixJQUFJLE1BQUE7UUFDSixTQUFTLFdBQUE7S0FDWixDQUFDLENBQUM7QUFDUCxDQUFDO0FBaEJELG9DQWdCQztBQUVELFNBQWdCLFlBQVksQ0FBRSxLQUFtQjtJQUM3QyxZQUFZLEdBQUcsS0FBSyxDQUFDO0lBQ3JCLDZCQUFxQixDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN2QyxDQUFDO0FBSEQsb0NBR0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBAQXV0aG9yOiB0YWNrY2hlblxyXG4gKiBARGF0ZTogMjAyMS0wNS0wMSAxOTozMjo0MlxyXG4gKiBATGFzdEVkaXRvcnM6IHRhY2tjaGVuXHJcbiAqIEBMYXN0RWRpdFRpbWU6IDIwMjEtMDUtMTIgMTM6NTY6NDVcclxuICogQEZpbGVQYXRoOiBcXG1wLW1peGluXFxzcmNcXG1peGluLnRzXHJcbiAqIEBEZXNjcmlwdGlvbjogQ29kaW5nIHNvbWV0aGluZ1xyXG4gKi9cclxuXHJcbmltcG9ydCB7VEFSR0VUX1RZUEV9IGZyb20gJy4vY29uc3RhbnQnO1xyXG5pbXBvcnQge2NoZWNrR2xvYmFsTWl4aW5TdG9yZSwgaW5qZWN0U3RvcmV9IGZyb20gJy4vc3RvcmUnO1xyXG5pbXBvcnQge0lDb21wb25lbnRNaXhpbiwgSUNvbXBvbmVudE9wdGlvbiwgSUNvbnRleHQsIElHbG9iYWxNaXhpbiwgSUpzb24sIElQYWdlTWl4aW4sIElQYWdlT3B0aW9ufSBmcm9tICcuL3R5cGUnO1xyXG5pbXBvcnQge2RlZXBDbG9uZSwgbWFwVG9UYXJnZXQsIHBpY2t9IGZyb20gJy4vdXRpbCc7XHJcblxyXG5sZXQgZ2xvYmFsTWl4aW5zOiBJR2xvYmFsTWl4aW47XHJcblxyXG5jb25zdCBwYWdlTGlmZVRpbWVOYW1lcyA9IFtcclxuICAgICdvbkxvYWQnLFxyXG4gICAgJ29uU2hvdycsXHJcbiAgICAnb25SZWFkeScsXHJcbiAgICAnb25IaWRlJyxcclxuICAgICdvblNob3cnLFxyXG4gICAgJ29uVW5sb2FkJyxcclxuXHJcbiAgICAnb25QdWxsRG93blJlZnJlc2gnLFxyXG4gICAgJ29uUmVhY2hCb3R0b20nLFxyXG4gICAgJ29uU2hhcmVBcHBNZXNzYWdlJyxcclxuICAgICdvblNoYXJlVGltZWxpbmUnLFxyXG4gICAgJ29uQWRkVG9GYXZvcml0ZXMnLFxyXG4gICAgJ29uUGFnZVNjcm9sbCcsXHJcbiAgICAnb25SZXNpemUnLFxyXG4gICAgJ29uVGFiSXRlbVRhcCcsXHJcbl07XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbWl4aW5EYXRhIChvcHRpb25zOiBJUGFnZU9wdGlvbiwgZGF0YT86IElKc29uKSB7XHJcbiAgICBpZiAodHlwZW9mIGRhdGEgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiBvcHRpb25zLmRhdGEgPT09ICd1bmRlZmluZWQnKSByZXR1cm47XHJcbiAgICBtYXBUb1RhcmdldCh7XHJcbiAgICAgICAgZGF0YSxcclxuICAgICAgICB0YXJnZXQ6IG9wdGlvbnMuZGF0YVxyXG4gICAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG1peGluTWV0aG9kcyAoXHJcbiAgICBvcHRpb25zOiBJUGFnZU9wdGlvbiB8IElDb21wb25lbnRPcHRpb24sXHJcbiAgICBtZXRob2RzPzogSUpzb248RnVuY3Rpb24+LFxyXG4gICAgdHlwZTogVEFSR0VUX1RZUEUgPSBUQVJHRVRfVFlQRS5QQUdFXHJcbikge1xyXG4gICAgaWYgKCFtZXRob2RzKSByZXR1cm47XHJcbiAgICBjb25zdCBpc0NvbXBvbmVudCA9IHR5cGUgPT09IFRBUkdFVF9UWVBFLkNPTVBPTkVOVDtcclxuICAgIGlmIChpc0NvbXBvbmVudCAmJiAhb3B0aW9ucy5tZXRob2RzKSB7XHJcbiAgICAgICAgb3B0aW9ucy5tZXRob2RzID0ge307XHJcbiAgICB9XHJcbiAgICBtYXBUb1RhcmdldCh7XHJcbiAgICAgICAgZGF0YTogbWV0aG9kcyxcclxuICAgICAgICB0YXJnZXQ6IGlzQ29tcG9uZW50ID9cclxuICAgICAgICAgICAgKG9wdGlvbnMgYXMgSUNvbXBvbmVudE9wdGlvbikubWV0aG9kcyBhcyBJSnNvbjxGdW5jdGlvbj4gOlxyXG4gICAgICAgICAgICBvcHRpb25zXHJcbiAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gbWl4aW5MaWZlVGltZXMgKFxyXG4gICAgb3B0aW9uczogSVBhZ2VPcHRpb24sXHJcbiAgICBtaXhpbjogSUdsb2JhbE1peGluIHwgSVBhZ2VNaXhpblxyXG4pIHtcclxuICAgIGNvbnN0IGxlZnRUaW1lcyA9IHBpY2sobWl4aW4sIHBhZ2VMaWZlVGltZU5hbWVzKTtcclxuICAgIFxyXG4gICAgbWFwVG9UYXJnZXQoe1xyXG4gICAgICAgIGRhdGE6IGxlZnRUaW1lcyxcclxuICAgICAgICB0YXJnZXQ6IG9wdGlvbnNcclxuICAgIH0pO1xyXG5cclxuICAgIG1hcmtVbmxvYWQob3B0aW9ucyk7XHJcbn1cclxuXHJcbi8vICEg5qCH6K6wIOW9k+WJjee7hOS7tuaIlumhtemdouiiq3VubG9hZOS6hu+8jCDnlKjmiLdzdG9yZeS4reWPlua2iOebkeWQrFxyXG5mdW5jdGlvbiBtYXJrVW5sb2FkIChsZWZ0VGltZXM6IElKc29uLCB0eXBlOiBUQVJHRVRfVFlQRSA9IFRBUkdFVF9UWVBFLlBBR0UpIHtcclxuICAgIGNvbnN0IG1hcmtVbmxvYWRGbGFnID0gZnVuY3Rpb24gKHRoaXM6IElDb250ZXh0KSB7XHJcbiAgICAgICAgdGhpcy5fX3VubG9hZCA9IHRydWU7XHJcbiAgICB9O1xyXG4gICAgY29uc3QgbmFtZSA9IHR5cGUgPT09IFRBUkdFVF9UWVBFLlBBR0UgPyAnb25VbmxvYWQnIDogJ2RldGFjaGVkJztcclxuICAgIGlmIChsZWZ0VGltZXNbbmFtZV0pIHtcclxuICAgICAgICBjb25zdCBuYXRpdmVNZXRob2QgPSBsZWZ0VGltZXNbbmFtZV07XHJcbiAgICAgICAgbGVmdFRpbWVzW25hbWVdID0gZnVuY3Rpb24gKHRoaXM6IElDb250ZXh0KSB7XHJcbiAgICAgICAgICAgIG5hdGl2ZU1ldGhvZC5jYWxsKHRoaXMpO1xyXG4gICAgICAgICAgICBtYXJrVW5sb2FkRmxhZy5jYWxsKHRoaXMpO1xyXG4gICAgICAgIH07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGxlZnRUaW1lc1tuYW1lXSA9IG1hcmtVbmxvYWRGbGFnO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBtaXhpbkNvbXBvbmVudExpZmVUaW1lcyAoXHJcbiAgICBvcHRpb25zOiBJQ29tcG9uZW50T3B0aW9uLFxyXG4gICAgbWl4aW46IElDb21wb25lbnRNaXhpblxyXG4pIHtcclxuICAgIGNvbnN0IGxlZnRUaW1lcyA9IG1peGluLmxpZmV0aW1lcztcclxuXHJcbiAgICBpZiAoIW9wdGlvbnMubGlmZXRpbWVzKSB7b3B0aW9ucy5saWZldGltZXMgPSB7fTt9XHJcbiAgICBpZiAobGVmdFRpbWVzKSB7XHJcbiAgICAgICAgbWFwVG9UYXJnZXQoe1xyXG4gICAgICAgICAgICBkYXRhOiBsZWZ0VGltZXMsXHJcbiAgICAgICAgICAgIHRhcmdldDogb3B0aW9ucy5saWZldGltZXNcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIG1hcmtVbmxvYWQob3B0aW9ucy5saWZldGltZXMsIFRBUkdFVF9UWVBFLkNPTVBPTkVOVCk7XHJcblxyXG4gICAgY29uc3QgcGFnZUxpZnRUaW1lcyA9IG1peGluLnBhZ2VMaWZldGltZXM7XHJcbiAgICBpZiAocGFnZUxpZnRUaW1lcykge1xyXG4gICAgICAgIGlmICghb3B0aW9ucy5wYWdlTGlmZXRpbWVzKSB7b3B0aW9ucy5wYWdlTGlmZXRpbWVzID0ge307fVxyXG4gICAgICAgIG1hcFRvVGFyZ2V0KHtcclxuICAgICAgICAgICAgZGF0YTogcGFnZUxpZnRUaW1lcyxcclxuICAgICAgICAgICAgdGFyZ2V0OiBvcHRpb25zLnBhZ2VMaWZldGltZXNcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1peGluQ3VycmVudCAoe1xyXG4gICAgb3B0aW9ucyxcclxuICAgIG1peGluLFxyXG4gICAgZ2xvYmFsID0gZmFsc2UsXHJcbiAgICB0eXBlID0gVEFSR0VUX1RZUEUuUEFHRSxcclxuICAgIHN0b3JlVG9vbCxcclxufToge1xyXG4gICAgb3B0aW9uczogSVBhZ2VPcHRpb24gfCBJQ29tcG9uZW50T3B0aW9uO1xyXG4gICAgbWl4aW4/OiBJR2xvYmFsTWl4aW4gfCBJUGFnZU1peGluO1xyXG4gICAgZ2xvYmFsPzogYm9vbGVhbjtcclxuICAgIHR5cGU/OiBUQVJHRVRfVFlQRTtcclxuICAgIHN0b3JlVG9vbDogSUpzb247XHJcbn0pIHtcclxuICAgIGlmICh0eXBlb2YgbWl4aW4gPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgICAgbWl4aW4gPSBvcHRpb25zLm1peGluO1xyXG4gICAgfVxyXG4gICAgaWYgKHR5cGVvZiBtaXhpbiA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgICByZXR1cm4gb3B0aW9ucztcclxuICAgIH1cclxuICBcclxuICAgIG1peGluID0gZGVlcENsb25lKG1peGluKSBhcyBJR2xvYmFsTWl4aW4gfCBJUGFnZU1peGluO1xyXG5cclxuICAgIGlmICh0eXBlID09PSBUQVJHRVRfVFlQRS5QQUdFKSB7XHJcbiAgICAgICAgbWl4aW5MaWZlVGltZXMob3B0aW9ucyBhcyBJUGFnZU9wdGlvbiwgbWl4aW4gYXMgSVBhZ2VNaXhpbik7XHJcbiAgICB9IGVsc2UgaWYgKHR5cGUgPT09IFRBUkdFVF9UWVBFLkNPTVBPTkVOVCkge1xyXG4gICAgICAgIG1peGluQ29tcG9uZW50TGlmZVRpbWVzKG9wdGlvbnMgYXMgSUNvbXBvbmVudE9wdGlvbiwgbWl4aW4gYXMgSUNvbXBvbmVudE1peGluKTtcclxuICAgIH1cclxuICAgIG1peGluRGF0YShvcHRpb25zLCBtaXhpbi5kYXRhKTtcclxuICAgIG1peGluTWV0aG9kcyhvcHRpb25zLCBtaXhpbi5tZXRob2RzLCB0eXBlKTtcclxuXHJcbiAgICBpbmplY3RTdG9yZSh7b3B0aW9ucywgbWl4aW5TdG9yZTogbWl4aW4uc3RvcmUsIGdsb2JhbCwgc3RvcmVUb29sfSk7XHJcblxyXG4gICAgcmV0dXJuIG9wdGlvbnM7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBfbWl4aW5HbG9iYWwgKHtcclxuICAgIG9wdGlvbnMsXHJcbiAgICB0eXBlLFxyXG4gICAgc3RvcmVUb29sXHJcbn06IHtcclxuICAgIG9wdGlvbnM6IElQYWdlT3B0aW9uIHwgSUNvbXBvbmVudE9wdGlvbjtcclxuICAgIHR5cGU6IFRBUkdFVF9UWVBFO1xyXG4gICAgc3RvcmVUb29sOiBJSnNvbjtcclxufSkge1xyXG4gICAgcmV0dXJuIG1peGluQ3VycmVudCh7XHJcbiAgICAgICAgb3B0aW9ucyxcclxuICAgICAgICBtaXhpbjogZ2xvYmFsTWl4aW5zLFxyXG4gICAgICAgIGdsb2JhbDogdHJ1ZSxcclxuICAgICAgICB0eXBlLFxyXG4gICAgICAgIHN0b3JlVG9vbFxyXG4gICAgfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBfZ2xvYmFsTWl4aW4gKG1peGluOiBJR2xvYmFsTWl4aW4pIHtcclxuICAgIGdsb2JhbE1peGlucyA9IG1peGluO1xyXG4gICAgY2hlY2tHbG9iYWxNaXhpblN0b3JlKG1peGluLnN0b3JlKTtcclxufSJdfQ==