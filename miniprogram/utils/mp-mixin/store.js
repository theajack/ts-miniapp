"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.injectStore = exports.checkGlobalMixinStore = exports._initGlobalStore = exports.initStoreHacker = exports._createStore = void 0;
var util_1 = require("./util");
var globalStore;
var storeId = 0;
function _createStore(state) {
    var currentId = ++storeId;
    var attrMap = {};
    var getAttrs = function (setDataAttr) {
        if (!attrMap[setDataAttr]) {
            attrMap[setDataAttr] = handleSetDataAttr(setDataAttr);
        }
        return attrMap[setDataAttr];
    };
    var _a = util_1.creatEventReady(), onEventReady = _a.onEventReady, eventReady = _a.eventReady;
    var modifyState = function (attrs, value, setDataAttr) {
        var data = state;
        var last = attrs.length - 1;
        attrs.forEach(function (attr, index) {
            var _a;
            if (index === last) {
                data[attr] = value;
                eventReady((_a = {}, _a[setDataAttr] = value, _a));
            }
            else {
                if (typeof data[attr] === 'undefined') {
                    throw new Error("Error setData:" + setDataAttr);
                }
                data = data[attr];
            }
        });
    };
    return {
        state: state,
        __: {
            _id: currentId,
            _injectContext: function (currentContext) {
                var mixin = currentContext.__mixin;
                if (mixin._store[currentId].inited) {
                    return;
                }
                mixin._context = currentContext;
                mixin._store[currentId].inited = true;
                hackSetData(currentContext, currentId);
                onEventReady(function (data) {
                    mixin._nativeSetData.call(currentContext, data);
                });
            },
            _hitState: function (setDataAttr, value, ignoreList) {
                var attrs = getAttrs(setDataAttr);
                var modifyAttr = attrs[0];
                if (typeof state[modifyAttr] === 'undefined' || ignoreList.includes(modifyAttr)) {
                    return false;
                }
                modifyState(attrs, value, setDataAttr);
                return true;
            }
        }
    };
}
exports._createStore = _createStore;
function hackSetData(context, storeId) {
    var nativeSetData = context.setData;
    var mixin = context.__mixin;
    if (!mixin._setDataList) {
        mixin._setDataList = [];
        mixin._nativeSetData = nativeSetData;
        context.setData = function (data, callback) {
            mixin._setDataList.forEach(function (fn) { return fn(data); });
            return nativeSetData.call(context, data, callback);
        };
    }
    mixin._setDataList.push(function (data) {
        var _a = mixin._store[storeId], store = _a.store, ignoreList = _a.ignoreList;
        for (var k in data) {
            store.__._hitState(k, data[k], ignoreList);
        }
    });
}
function handleSetDataAttr(attr) {
    attr = attr.replace(/\[/g, '.').replace(/\]/g, '');
    return attr.split('.');
}
function initStoreHacker(options) {
    var stores = options.__mixin._store;
    if (stores) {
        for (var k in stores) {
            handleStore(options, stores[k].store);
        }
    }
}
exports.initStoreHacker = initStoreHacker;
function handleStore(options, store) {
    if (!store)
        return;
    var setDataHacker = function () {
        store.__._injectContext(this);
    };
    if (!options.onLoad) {
        options.onLoad = setDataHacker;
    }
    else {
        var nativeOnLoad_1 = options.onLoad;
        var mixin_1 = options.__mixin;
        if (!mixin_1._onLoadList) {
            mixin_1._onLoadList = [];
            options.onLoad = function () {
                var _this = this;
                var args = [];
                for (var _i = 0; _i < arguments.length; _i++) {
                    args[_i] = arguments[_i];
                }
                mixin_1._onLoadList.forEach(function (fn) { return fn.call(_this); });
                nativeOnLoad_1.apply(this, args);
            };
        }
        mixin_1._onLoadList.push(setDataHacker);
    }
}
function _initGlobalStore(state) {
    globalStore = ((!state.__) ? _createStore(state) : state);
    return globalStore;
}
exports._initGlobalStore = _initGlobalStore;
function checkGlobalMixinStore(store) {
    if (!store)
        return;
    _initGlobalStore(store);
}
exports.checkGlobalMixinStore = checkGlobalMixinStore;
function injectStore(options, mixinStore, global) {
    if (global === void 0) { global = false; }
    var store = ((global) ? globalStore : (options.store || mixinStore));
    if (!store)
        return;
    var mixin = options.__mixin;
    if (!mixin._store) {
        mixin._store = {};
    }
    ;
    mixin._store[store.__._id] = {
        store: store,
        ignoreList: util_1.mapToTarget({
            data: store.state,
            target: options.data
        })
    };
}
exports.injectStore = injectStore;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzdG9yZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFVQSwrQkFBb0Q7QUFFcEQsSUFBSSxXQUFtQixDQUFDO0FBQ3hCLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQztBQUNoQixTQUFnQixZQUFZLENBQUUsS0FBWTtJQUN0QyxJQUFNLFNBQVMsR0FBRyxFQUFFLE9BQU8sQ0FBQztJQUU1QixJQUFNLE9BQU8sR0FBb0IsRUFBRSxDQUFDO0lBQ3BDLElBQU0sUUFBUSxHQUFHLFVBQUMsV0FBbUI7UUFDakMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsRUFBRTtZQUN2QixPQUFPLENBQUMsV0FBVyxDQUFDLEdBQUcsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7U0FDekQ7UUFDRCxPQUFPLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNoQyxDQUFDLENBQUM7SUFDSSxJQUFBLEtBQTZCLHNCQUFlLEVBQVMsRUFBcEQsWUFBWSxrQkFBQSxFQUFFLFVBQVUsZ0JBQTRCLENBQUM7SUFFNUQsSUFBTSxXQUFXLEdBQUcsVUFDaEIsS0FBZSxFQUFFLEtBQVUsRUFBRSxXQUFtQjtRQUVoRCxJQUFJLElBQUksR0FBRyxLQUFLLENBQUM7UUFDakIsSUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFDOUIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFDLElBQVksRUFBRSxLQUFhOztZQUN0QyxJQUFJLEtBQUssS0FBSyxJQUFJLEVBQUU7Z0JBQ2hCLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUM7Z0JBQ25CLFVBQVUsV0FBRSxHQUFDLFdBQVcsSUFBRyxLQUFLLE1BQUUsQ0FBQzthQUN0QztpQkFBTTtnQkFDSCxJQUFJLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLFdBQVcsRUFBRTtvQkFDbkMsTUFBTSxJQUFJLEtBQUssQ0FB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WUFDcEIsSUFBSSxFQUFFLEtBQUssQ0FBQyxLQUFLO1lBQ2pCLE1BQU0sRUFBRSxPQUFPLENBQUMsSUFBSTtTQUN2QixDQUFDO0tBQ0wsQ0FBQztBQUNOLENBQUM7QUFoQkQsa0NBZ0JDIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuICogQEF1dGhvcjogdGFja2NoZW5cclxuICogQERhdGU6IDIwMjEtMDUtMDEgMjA6Mjk6NDdcclxuICogQExhc3RFZGl0b3JzOiB0aGVhamFja1xyXG4gKiBATGFzdEVkaXRUaW1lOiAyMDIxLTA1LTA0IDAwOjU4OjI2XHJcbiAqIEBGaWxlUGF0aDogXFxtcC1taXhpblxcc3JjXFxzdG9yZS50c1xyXG4gKiBARGVzY3JpcHRpb246IENvZGluZyBzb21ldGhpbmdcclxuICovXHJcblxyXG5pbXBvcnQge0lDb250ZXh0LCBJSnNvbiwgSVBhZ2VPcHRpb24sIElTdG9yZX0gZnJvbSAnLi90eXBlJztcclxuaW1wb3J0IHttYXBUb1RhcmdldCwgY3JlYXRFdmVudFJlYWR5fSBmcm9tICcuL3V0aWwnO1xyXG5cclxubGV0IGdsb2JhbFN0b3JlOiBJU3RvcmU7XHJcbmxldCBzdG9yZUlkID0gMDtcclxuZXhwb3J0IGZ1bmN0aW9uIF9jcmVhdGVTdG9yZSAoc3RhdGU6IElKc29uKTogSVN0b3JlIHtcclxuICAgIGNvbnN0IGN1cnJlbnRJZCA9ICsrc3RvcmVJZDtcclxuICAgIC8vIOe8k+WtmHNldERhdGEga2V5XHJcbiAgICBjb25zdCBhdHRyTWFwOiBJSnNvbjxzdHJpbmdbXT4gPSB7fTtcclxuICAgIGNvbnN0IGdldEF0dHJzID0gKHNldERhdGFBdHRyOiBzdHJpbmcpID0+IHtcclxuICAgICAgICBpZiAoIWF0dHJNYXBbc2V0RGF0YUF0dHJdKSB7XHJcbiAgICAgICAgICAgIGF0dHJNYXBbc2V0RGF0YUF0dHJdID0gaGFuZGxlU2V0RGF0YUF0dHIoc2V0RGF0YUF0dHIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYXR0ck1hcFtzZXREYXRhQXR0cl07XHJcbiAgICB9O1xyXG4gICAgY29uc3Qge29uRXZlbnRSZWFkeSwgZXZlbnRSZWFkeX0gPSBjcmVhdEV2ZW50UmVhZHk8SUpzb24+KCk7XHJcblxyXG4gICAgY29uc3QgbW9kaWZ5U3RhdGUgPSAoXHJcbiAgICAgICAgYXR0cnM6IHN0cmluZ1tdLCB2YWx1ZTogYW55LCBzZXREYXRhQXR0cjogc3RyaW5nXHJcbiAgICApID0+IHtcclxuICAgICAgICBsZXQgZGF0YSA9IHN0YXRlO1xyXG4gICAgICAgIGNvbnN0IGxhc3QgPSBhdHRycy5sZW5ndGggLSAxO1xyXG4gICAgICAgIGF0dHJzLmZvckVhY2goKGF0dHI6IHN0cmluZywgaW5kZXg6IG51bWJlcikgPT4ge1xyXG4gICAgICAgICAgICBpZiAoaW5kZXggPT09IGxhc3QpIHtcclxuICAgICAgICAgICAgICAgIGRhdGFbYXR0cl0gPSB2YWx1ZTtcclxuICAgICAgICAgICAgICAgIGV2ZW50UmVhZHkoe1tzZXREYXRhQXR0cl06IHZhbHVlfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGRhdGFbYXR0cl0gPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBFcnJvciBzZXREYXRhOiR7c2V0RGF0YUF0dHJ9YCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBkYXRhID0gZGF0YVthdHRyXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHN0YXRlLFxyXG4gICAgICAgIF9fOiB7XHJcbiAgICAgICAgICAgIF9pZDogY3VycmVudElkLFxyXG4gICAgICAgICAgICBfaW5qZWN0Q29udGV4dCAoY3VycmVudENvbnRleHQ6IElDb250ZXh0KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBtaXhpbiA9IGN1cnJlbnRDb250ZXh0Ll9fbWl4aW47XHJcbiAgICAgICAgICAgICAgICBpZiAobWl4aW4uX3N0b3JlW2N1cnJlbnRJZF0uaW5pdGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgbWl4aW4uX2NvbnRleHQgPSBjdXJyZW50Q29udGV4dDtcclxuICAgICAgICAgICAgICAgIG1peGluLl9zdG9yZVtjdXJyZW50SWRdLmluaXRlZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBoYWNrU2V0RGF0YShjdXJyZW50Q29udGV4dCwgY3VycmVudElkKTtcclxuICAgICAgICAgICAgICAgIG9uRXZlbnRSZWFkeSgoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIG1peGluLl9uYXRpdmVTZXREYXRhLmNhbGwoY3VycmVudENvbnRleHQsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIF9oaXRTdGF0ZSAoc2V0RGF0YUF0dHI6IHN0cmluZywgdmFsdWU6IGFueSwgaWdub3JlTGlzdDogc3RyaW5nW10pIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJzID0gZ2V0QXR0cnMoc2V0RGF0YUF0dHIpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbW9kaWZ5QXR0ciA9IGF0dHJzWzBdO1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzdGF0ZVttb2RpZnlBdHRyXSA9PT0gJ3VuZGVmaW5lZCcgfHwgaWdub3JlTGlzdC5pbmNsdWRlcyhtb2RpZnlBdHRyKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIG1vZGlmeVN0YXRlKGF0dHJzLCB2YWx1ZSwgc2V0RGF0YUF0dHIpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59XHJcblxyXG5mdW5jdGlvbiBoYWNrU2V0RGF0YSAoY29udGV4dDogSUNvbnRleHQsIHN0b3JlSWQ6IG51bWJlcikge1xyXG4gICAgY29uc3QgbmF0aXZlU2V0RGF0YSA9IGNvbnRleHQuc2V0RGF0YTtcclxuICAgIGNvbnN0IG1peGluID0gY29udGV4dC5fX21peGluO1xyXG4gICAgaWYgKCFtaXhpbi5fc2V0RGF0YUxpc3QpIHtcclxuICAgICAgICBtaXhpbi5fc2V0RGF0YUxpc3QgPSBbXTtcclxuICAgICAgICBtaXhpbi5fbmF0aXZlU2V0RGF0YSA9IG5hdGl2ZVNldERhdGE7XHJcbiAgICAgICAgY29udGV4dC5zZXREYXRhID0gKGRhdGEsIGNhbGxiYWNrKSA9PiB7XHJcbiAgICAgICAgICAgIG1peGluLl9zZXREYXRhTGlzdC5mb3JFYWNoKChmbjogRnVuY3Rpb24pID0+IGZuKGRhdGEpKTtcclxuICAgICAgICAgICAgcmV0dXJuIG5hdGl2ZVNldERhdGEuY2FsbChjb250ZXh0LCBkYXRhLCBjYWxsYmFjayk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIG1peGluLl9zZXREYXRhTGlzdC5wdXNoKChkYXRhOiBJSnNvbikgPT4ge1xyXG4gICAgICAgIGNvbnN0IHtzdG9yZSwgaWdub3JlTGlzdH0gPSBtaXhpbi5fc3RvcmVbc3RvcmVJZF07XHJcbiAgICAgICAgZm9yIChjb25zdCBrIGluIGRhdGEpIHtcclxuICAgICAgICAgICAgc3RvcmUuX18uX2hpdFN0YXRlKGssIGRhdGFba10sIGlnbm9yZUxpc3QpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBoYW5kbGVTZXREYXRhQXR0ciAoYXR0cjogc3RyaW5nKSB7XHJcbiAgICBhdHRyID0gYXR0ci5yZXBsYWNlKC9cXFsvZywgJy4nKS5yZXBsYWNlKC9cXF0vZywgJycpO1xyXG4gICAgcmV0dXJuIGF0dHIuc3BsaXQoJy4nKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGluaXRTdG9yZUhhY2tlciAob3B0aW9uczogSVBhZ2VPcHRpb24pIHtcclxuICAgIGNvbnN0IHN0b3JlcyA9IG9wdGlvbnMuX19taXhpbi5fc3RvcmU7XHJcbiAgICBpZiAoc3RvcmVzKSB7XHJcbiAgICAgICAgZm9yIChjb25zdCBrIGluIHN0b3Jlcykge1xyXG4gICAgICAgICAgICBoYW5kbGVTdG9yZShvcHRpb25zLCBzdG9yZXNba10uc3RvcmUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlU3RvcmUgKG9wdGlvbnM6IElQYWdlT3B0aW9uLCBzdG9yZTogSVN0b3JlKSB7XHJcbiAgICBpZiAoIXN0b3JlKSByZXR1cm47XHJcbiAgICBjb25zdCBzZXREYXRhSGFja2VyID0gZnVuY3Rpb24gKHRoaXM6IElDb250ZXh0KSB7XHJcbiAgICAgICAgc3RvcmUuX18uX2luamVjdENvbnRleHQodGhpcyk7XHJcbiAgICB9O1xyXG4gICAgaWYgKCFvcHRpb25zLm9uTG9hZCkgeyAvLyDliqvmjIFvbkxvYWTmnaXms6jlhaVzZXREYXRhXHJcbiAgICAgICAgb3B0aW9ucy5vbkxvYWQgPSBzZXREYXRhSGFja2VyO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCBuYXRpdmVPbkxvYWQgPSBvcHRpb25zLm9uTG9hZDtcclxuICAgICAgICBjb25zdCBtaXhpbiA9IG9wdGlvbnMuX19taXhpbjtcclxuICAgICAgICBpZiAoIW1peGluLl9vbkxvYWRMaXN0KSB7XHJcbiAgICAgICAgICAgIG1peGluLl9vbkxvYWRMaXN0ID0gW107XHJcbiAgICAgICAgICAgIG9wdGlvbnMub25Mb2FkID0gZnVuY3Rpb24gKHRoaXM6IElDb250ZXh0LCAuLi5hcmdzOiBhbnlbXSkge1xyXG4gICAgICAgICAgICAgICAgbWl4aW4uX29uTG9hZExpc3QuZm9yRWFjaCgoZm46ICh0aGlzOiBJQ29udGV4dCkgPT4gdm9pZCkgPT4gZm4uY2FsbCh0aGlzKSk7XHJcbiAgICAgICAgICAgICAgICBuYXRpdmVPbkxvYWQuYXBwbHkodGhpcywgYXJncyk7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gIFxyXG4gICAgICAgIG1peGluLl9vbkxvYWRMaXN0LnB1c2goc2V0RGF0YUhhY2tlcik7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBfaW5pdEdsb2JhbFN0b3JlIChzdGF0ZTogSUpzb24gfCBJU3RvcmUpIHtcclxuICAgIGdsb2JhbFN0b3JlID0gKCghc3RhdGUuX18pID8gX2NyZWF0ZVN0b3JlKHN0YXRlKSA6IHN0YXRlKSBhcyBJU3RvcmU7XHJcbiAgICByZXR1cm4gZ2xvYmFsU3RvcmU7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjaGVja0dsb2JhbE1peGluU3RvcmUgKHN0b3JlPzogSUpzb24gfCBJU3RvcmUpIHtcclxuICAgIGlmICghc3RvcmUpIHJldHVybjtcclxuICAgIF9pbml0R2xvYmFsU3RvcmUoc3RvcmUpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaW5qZWN0U3RvcmUgKFxyXG4gICAgb3B0aW9uczogSVBhZ2VPcHRpb24sXHJcbiAgICBtaXhpblN0b3JlPzogSVN0b3JlIHwgSUpzb248YW55PixcclxuICAgIGdsb2JhbCA9IGZhbHNlXHJcbikge1xyXG4gICAgY29uc3Qgc3RvcmUgPSAoKGdsb2JhbCkgPyBnbG9iYWxTdG9yZSA6IChvcHRpb25zLnN0b3JlIHx8IG1peGluU3RvcmUpKSBhcyBJU3RvcmU7XHJcbiAgICBpZiAoIXN0b3JlKSByZXR1cm47XHJcbiAgICBjb25zdCBtaXhpbiA9IG9wdGlvbnMuX19taXhpbjtcclxuICAgIGlmICghbWl4aW4uX3N0b3JlKSB7bWl4aW4uX3N0b3JlID0ge307fTtcclxuICAgIG1peGluLl9zdG9yZVtzdG9yZS5fXy5faWRdID0ge1xyXG4gICAgICAgIHN0b3JlLFxyXG4gICAgICAgIGlnbm9yZUxpc3Q6IG1hcFRvVGFyZ2V0KHtcclxuICAgICAgICAgICAgZGF0YTogc3RvcmUuc3RhdGUsXHJcbiAgICAgICAgICAgIHRhcmdldDogb3B0aW9ucy5kYXRhXHJcbiAgICAgICAgfSlcclxuICAgIH07XHJcbn0iXX0=