"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.injectStore = exports.checkGlobalMixinStore = exports._initGlobalStore = exports.initStoreHacker = exports._createStore = void 0;
var util_1 = require("./util");
var globalStore;
var storeId = 0;
function _createStore(state) {
    var currentId = ++storeId;
    var attrMap = {};
    var getAttrs = function (setDataAttr) {
        if (!attrMap[setDataAttr]) {
            attrMap[setDataAttr] = handleSetDataAttr(setDataAttr);
        }
        return attrMap[setDataAttr];
    };
    var _a = util_1.creatEventReady(), onEventReady = _a.onEventReady, eventReady = _a.eventReady, removeListener = _a.removeListener;
    var modifyState = function (attrs, value, setDataAttr, newContext) {
        var data = state;
        var last = attrs.length - 1;
        attrs.forEach(function (attr, index) {
            var _a;
            if (index === last) {
                data[attr] = value;
                eventReady((_a = {}, _a[setDataAttr] = value, _a), newContext);
            }
            else {
                if (typeof data[attr] === 'undefined') {
                    throw new Error("Error setData:" + setDataAttr);
                }
                data = data[attr];
            }
        });
    };
    return {
        state: state,
        __: {
            _id: currentId,
            _injectContext: function (currentContext, storeTool) {
                hackSetData(currentContext, currentId, storeTool);
                var listener = onEventReady(function (data, newContext) {
                    if (currentContext.__unload) {
                        removeListener(listener);
                    }
                    else if (currentContext !== newContext) {
                        console.log('onEventReady', data);
                        storeTool._nativeSetData.call(currentContext, data);
                    }
                });
            },
            _hitState: function (setDataAttr, value, ignoreList, newContext) {
                var attrs = getAttrs(setDataAttr);
                var modifyAttr = attrs[0];
                if (typeof state[modifyAttr] === 'undefined' || ignoreList.indexOf(modifyAttr) !== -1) {
                    return false;
                }
                modifyState(attrs, value, setDataAttr, newContext);
                return true;
            }
        }
    };
}
exports._createStore = _createStore;
function hackSetData(context, storeId, storeTool) {
    var nativeSetData = context.setData;
    if (!context._setDataList) {
        context._setDataList = [];
        storeTool._nativeSetData = nativeSetData;
        context.setData = function (data, callback) {
            context._setDataList.forEach(function (fn) { return fn(data); });
            console.log('nativeSetData.call(context, data, callback);', data);
            return nativeSetData.call(context, data, callback);
        };
    }
    context._setDataList.push(function (data) {
        var _a = storeTool._store[storeId], store = _a.store, ignoreList = _a.ignoreList;
        for (var k in data) {
            store.__._hitState(k, data[k], ignoreList, context);
        }
    });
}
function handleSetDataAttr(attr) {
    attr = attr.replace(/\[/g, '.').replace(/\]/g, '');
    return attr.split('.');
}
function initStoreHacker(_a) {
    var options = _a.options, type = _a.type, storeTool = _a.storeTool;
    var stores = storeTool._store;
    if (stores) {
        for (var k in stores) {
            handleStore({
                options: options,
                store: stores[k].store,
                type: type,
                storeTool: storeTool
            });
        }
    }
}
exports.initStoreHacker = initStoreHacker;
function readOnloadLifeTime(options, type) {
    if (type === 0) {
        return options.onLoad;
    }
    else if (type === 1) {
        if (options.lifetimes) {
            return options.lifetimes.attached;
        }
    }
    return null;
}
function writeOnloadLifeTime(options, type, func) {
    if (type === 0) {
        options.onLoad = func;
    }
    else if (type === 1) {
        if (!options.lifetimes) {
            options.lifetimes = {};
        }
        options.lifetimes.attached = func;
    }
}
function handleStore(_a) {
    var options = _a.options, store = _a.store, type = _a.type, storeTool = _a.storeTool;
    if (!store)
        return;
    var setDataHacker = function () {
        store.__._injectContext(this, storeTool);
    };
    var nativeOnLoad = readOnloadLifeTime(options, type);
    if (!nativeOnLoad) {
        writeOnloadLifeTime(options, type, setDataHacker);
    }
    else {
        if (!storeTool._onLoadList) {
            storeTool._onLoadList = [];
            var onLoadHacker = function () {
                var _this = this;
                var args = [];
                for (var _i = 0; _i < arguments.length; _i++) {
                    args[_i] = arguments[_i];
                }
                storeTool._onLoadList.forEach(function (fn) { return fn.call(_this); });
                nativeOnLoad.apply(this, args);
            };
            writeOnloadLifeTime(options, type, onLoadHacker);
        }
        storeTool._onLoadList.push(setDataHacker);
    }
}
function _initGlobalStore(state) {
    globalStore = ((!state.__) ? _createStore(state) : state);
    return globalStore;
}
exports._initGlobalStore = _initGlobalStore;
function checkGlobalMixinStore(store) {
    if (!store)
        return;
    _initGlobalStore(store);
}
exports.checkGlobalMixinStore = checkGlobalMixinStore;
function injectStore(_a) {
    var options = _a.options, mixinStore = _a.mixinStore, storeTool = _a.storeTool, _b = _a.global, global = _b === void 0 ? false : _b;
    if (typeof options.data === 'undefined')
        return;
    var store = ((global) ? globalStore : (options.store || mixinStore));
    if (!store)
        return;
    if (!storeTool._store) {
        storeTool._store = {};
    }
    ;
    storeTool._store[store.__._id] = {
        store: store,
        ignoreList: util_1.mapToTarget({
            data: store.state,
            target: options.data
        })
    };
}
exports.injectStore = injectStore;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzdG9yZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFXQSwrQkFBb0Q7QUFFcEQsSUFBSSxXQUFtQixDQUFDO0FBQ3hCLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQztBQUNoQixTQUFnQixZQUFZLENBQUUsS0FBWTtJQUN0QyxJQUFNLFNBQVMsR0FBRyxFQUFFLE9BQU8sQ0FBQztJQUU1QixJQUFNLE9BQU8sR0FBb0IsRUFBRSxDQUFDO0lBQ3BDLElBQU0sUUFBUSxHQUFHLFVBQUMsV0FBbUI7UUFDakMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsRUFBRTtZQUN2QixPQUFPLENBQUMsV0FBVyxDQUFDLEdBQUcsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7U0FDekQ7UUFDRCxPQUFPLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNoQyxDQUFDLENBQUM7SUFDSSxJQUFBLEtBQTZDLHNCQUFlLEVBQVMsRUFBcEUsWUFBWSxrQkFBQSxFQUFFLFVBQVUsZ0JBQUEsRUFBRSxjQUFjLG9CQUE0QixDQUFDO0lBRTVFLElBQU0sV0FBVyxHQUFHLFVBQ2hCLEtBQWUsRUFBRSxLQUFVLEVBQUUsV0FBbUIsRUFBRSxVQUFvQjtRQUV0RSxJQUFJLElBQUksR0FBRyxLQUFLLENBQUM7UUFDakIsSUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFDOUIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFDLElBQVksRUFBRSxLQUFhOztZQUN0QyxJQUFJLEtBQUssS0FBSyxJQUFJLEVBQUU7Z0JBQ2hCLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUM7Z0JBQ25CLFVBQVUsV0FBRSxHQUFDLFdBQVcsSUFBRyxLQUFLLE9BQUcsVUFBVSxDQUFDLENBQUM7YUFDbEQ7aUJBQU07Z0JBQ0gsSUFBSSxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxXQUFXLEVBQUU7b0JBQ25DLE1BQU0sSUFBSSxLQUFLLENBQUMsbUJBQWlCLFdBQWEsQ0FBQyxDQUFDO2lCQUNuRDtnQkFDRCxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3JCO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUM7SUFFRixPQUFPO1FBQ0gsS0FBSyxPQUFBO1FBQ0wsRUFBRSxFQUFFO1lBQ0EsR0FBRyxFQUFFLFNBQVM7WUFDZCxjQUFjLEVBQWQsVUFBZ0IsY0FBd0IsRUFBRSxTQUFnQjtnQkFDdEQsV0FBVyxDQUFDLGNBQWMsRUFBRSxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUM7Z0JBQ2xELElBQU0sUUFBUSxHQUFHLFlBQVksQ0FBQyxVQUFDLElBQUksRUFBRSxVQUFVO29CQUMzQyxJQUFJLGNBQWMsQ0FBQyxRQUFRLEVBQUU7d0JBRXpCLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQztxQkFDNUI7eUJBQU0sSUFBSSxjQUFjLEtBQUssVUFBVSxFQUFFO3dCQUV0QyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsQ0FBQzt3QkFDbEMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyxDQUFDO3FCQUN2RDtnQkFDTCxDQUFDLENBQUMsQ0FBQztZQUNQLENBQUM7WUFDRCxTQUFTLEVBQVQsVUFBVyxXQUFtQixFQUFFLEtBQVUsRUFBRSxVQUFvQixFQUFFLFVBQW9CO2dCQUNsRixJQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7Z0JBQ3BDLElBQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDNUIsSUFBSSxPQUFPLEtBQUssQ0FBQyxVQUFVLENBQUMsS0FBSyxXQUFXLElBQUksVUFBVSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtvQkFDbkYsT0FBTyxLQUFLLENBQUM7aUJBQ2hCO2dCQUNELFdBQVcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxVQUFVLENBQUMsQ0FBQztnQkFDbkQsT0FBTyxJQUFJLENBQUM7WUFDaEIsQ0FBQztTQUNKO0tBQ0osQ0FBQztBQUNOLENBQUM7QUExREQsb0NBMERDO0FBS0QsU0FBUyxXQUFXLENBQUUsT0FBaUIsRUFBRSxPQUFlLEVBQUUsU0FBZ0I7SUFDdEUsSUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQztJQUd0QyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRTtRQUN2QixPQUFPLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQztRQUMxQixTQUFTLENBQUMsY0FBYyxHQUFHLGFBQWEsQ0FBQztRQUN6QyxPQUFPLENBQUMsT0FBTyxHQUFHLFVBQUMsSUFBSSxFQUFFLFFBQVE7WUFDN0IsT0FBTyxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsVUFBQyxFQUFZLElBQUssT0FBQSxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQVIsQ0FBUSxDQUFDLENBQUM7WUFDekQsT0FBTyxDQUFDLEdBQUcsQ0FBQyw4Q0FBOEMsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUNsRSxPQUFPLGFBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztRQUN2RCxDQUFDLENBQUM7S0FDTDtJQUNELE9BQU8sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQUMsSUFBVztRQUM1QixJQUFBLEtBQXNCLFNBQVMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEVBQTlDLEtBQUssV0FBQSxFQUFFLFVBQVUsZ0JBQTZCLENBQUM7UUFDdEQsS0FBSyxJQUFNLENBQUMsSUFBSSxJQUFJLEVBQUU7WUFDbEIsS0FBSyxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxVQUFVLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDdkQ7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRCxTQUFTLGlCQUFpQixDQUFFLElBQVk7SUFDcEMsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDbkQsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzNCLENBQUM7QUFHRCxTQUFnQixlQUFlLENBQUUsRUFRaEM7UUFQRyxPQUFPLGFBQUEsRUFDUCxJQUFJLFVBQUEsRUFDSixTQUFTLGVBQUE7SUFNVCxJQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDO0lBQ2hDLElBQUksTUFBTSxFQUFFO1FBQ1IsS0FBSyxJQUFNLENBQUMsSUFBSSxNQUFNLEVBQUU7WUFDcEIsV0FBVyxDQUFDO2dCQUNSLE9BQU8sU0FBQTtnQkFDUCxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUs7Z0JBQ3RCLElBQUksTUFBQTtnQkFDSixTQUFTLFdBQUE7YUFDWixDQUFDLENBQUM7U0FDTjtLQUNKO0FBQ0wsQ0FBQztBQXBCRCwwQ0FvQkM7QUFFRCxTQUFTLGtCQUFrQixDQUFFLE9BQXVDLEVBQUUsSUFBaUI7SUFDbkYsSUFBSSxJQUFJLE1BQXFCLEVBQUU7UUFDM0IsT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDO0tBQ3pCO1NBQU0sSUFBSSxJQUFJLE1BQTBCLEVBQUU7UUFDdkMsSUFBSSxPQUFPLENBQUMsU0FBUyxFQUFFO1lBQ25CLE9BQU8sT0FBTyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUM7U0FDckM7S0FDSjtJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2hCLENBQUM7QUFFRCxTQUFTLG1CQUFtQixDQUN4QixPQUF1QyxFQUN2QyxJQUFpQixFQUNqQixJQUE4QjtJQUU5QixJQUFJLElBQUksTUFBcUIsRUFBRTtRQUMzQixPQUFPLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztLQUN6QjtTQUFNLElBQUksSUFBSSxNQUEwQixFQUFFO1FBQ3ZDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFO1lBQUMsT0FBTyxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7U0FBQztRQUNqRCxPQUFPLENBQUMsU0FBUyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7S0FDckM7QUFDTCxDQUFDO0FBRUQsU0FBUyxXQUFXLENBQUUsRUFVckI7UUFURyxPQUFPLGFBQUEsRUFDUCxLQUFLLFdBQUEsRUFDTCxJQUFJLFVBQUEsRUFDSixTQUFTLGVBQUE7SUFPVCxJQUFJLENBQUMsS0FBSztRQUFFLE9BQU87SUFDbkIsSUFBTSxhQUFhLEdBQUc7UUFDbEIsS0FBSyxDQUFDLEVBQUUsQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQzdDLENBQUMsQ0FBQztJQUNGLElBQU0sWUFBWSxHQUFHLGtCQUFrQixDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN2RCxJQUFJLENBQUMsWUFBWSxFQUFFO1FBQ2YsbUJBQW1CLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQztLQUNyRDtTQUFNO1FBQ0gsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUU7WUFDeEIsU0FBUyxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7WUFDM0IsSUFBTSxZQUFZLEdBQUc7Z0JBQUEsaUJBR3BCO2dCQUg4QyxjQUFjO3FCQUFkLFVBQWMsRUFBZCxxQkFBYyxFQUFkLElBQWM7b0JBQWQseUJBQWM7O2dCQUN6RCxTQUFTLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxVQUFDLEVBQTRCLElBQUssT0FBQSxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUksQ0FBQyxFQUFiLENBQWEsQ0FBQyxDQUFDO2dCQUMvRSxZQUFZLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztZQUNuQyxDQUFDLENBQUM7WUFDRixtQkFBbUIsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLFlBQVksQ0FBQyxDQUFDO1NBQ3BEO1FBRUQsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7S0FDN0M7QUFDTCxDQUFDO0FBQ0QsU0FBZ0IsZ0JBQWdCLENBQUUsS0FBcUI7SUFDbkQsV0FBVyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQVcsQ0FBQztJQUNwRSxPQUFPLFdBQVcsQ0FBQztBQUN2QixDQUFDO0FBSEQsNENBR0M7QUFFRCxTQUFnQixxQkFBcUIsQ0FBRSxLQUFzQjtJQUN6RCxJQUFJLENBQUMsS0FBSztRQUFFLE9BQU87SUFDbkIsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDNUIsQ0FBQztBQUhELHNEQUdDO0FBRUQsU0FBZ0IsV0FBVyxDQUFFLEVBVTVCO1FBVEcsT0FBTyxhQUFBLEVBQ1AsVUFBVSxnQkFBQSxFQUNWLFNBQVMsZUFBQSxFQUNULGNBQWMsRUFBZCxNQUFNLG1CQUFHLEtBQUssS0FBQTtJQU9kLElBQUksT0FBTyxPQUFPLENBQUMsSUFBSSxLQUFLLFdBQVc7UUFBRSxPQUFPO0lBQ2hELElBQU0sS0FBSyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLElBQUksVUFBVSxDQUFDLENBQVcsQ0FBQztJQUNqRixJQUFJLENBQUMsS0FBSztRQUFFLE9BQU87SUFDbkIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUU7UUFBQyxTQUFTLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztLQUFDO0lBQUEsQ0FBQztJQUNoRCxTQUFTLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUc7UUFDN0IsS0FBSyxPQUFBO1FBQ0wsVUFBVSxFQUFFLGtCQUFXLENBQUM7WUFDcEIsSUFBSSxFQUFFLEtBQUssQ0FBQyxLQUFLO1lBQ2pCLE1BQU0sRUFBRSxPQUFPLENBQUMsSUFBSTtTQUN2QixDQUFDO0tBQ0wsQ0FBQztBQUNOLENBQUM7QUF0QkQsa0NBc0JDIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuICogQEF1dGhvcjogdGFja2NoZW5cclxuICogQERhdGU6IDIwMjEtMDUtMDEgMjA6Mjk6NDdcclxuICogQExhc3RFZGl0b3JzOiB0YWNrY2hlblxyXG4gKiBATGFzdEVkaXRUaW1lOiAyMDIxLTA1LTEyIDEzOjU3OjU3XHJcbiAqIEBGaWxlUGF0aDogXFxtcC1taXhpblxcc3JjXFxzdG9yZS50c1xyXG4gKiBARGVzY3JpcHRpb246IOeKtuaAgeWFseS6q1xyXG4gKi9cclxuXHJcbmltcG9ydCB7VEFSR0VUX1RZUEV9IGZyb20gJy4vY29uc3RhbnQnO1xyXG5pbXBvcnQge0lDb21wb25lbnRPcHRpb24sIElDb250ZXh0LCBJSnNvbiwgSVBhZ2VPcHRpb24sIElTdG9yZX0gZnJvbSAnLi90eXBlJztcclxuaW1wb3J0IHttYXBUb1RhcmdldCwgY3JlYXRFdmVudFJlYWR5fSBmcm9tICcuL3V0aWwnO1xyXG5cclxubGV0IGdsb2JhbFN0b3JlOiBJU3RvcmU7XHJcbmxldCBzdG9yZUlkID0gMDtcclxuZXhwb3J0IGZ1bmN0aW9uIF9jcmVhdGVTdG9yZSAoc3RhdGU6IElKc29uKTogSVN0b3JlIHtcclxuICAgIGNvbnN0IGN1cnJlbnRJZCA9ICsrc3RvcmVJZDtcclxuICAgIC8vIOe8k+WtmHNldERhdGEga2V5XHJcbiAgICBjb25zdCBhdHRyTWFwOiBJSnNvbjxzdHJpbmdbXT4gPSB7fTtcclxuICAgIGNvbnN0IGdldEF0dHJzID0gKHNldERhdGFBdHRyOiBzdHJpbmcpID0+IHtcclxuICAgICAgICBpZiAoIWF0dHJNYXBbc2V0RGF0YUF0dHJdKSB7XHJcbiAgICAgICAgICAgIGF0dHJNYXBbc2V0RGF0YUF0dHJdID0gaGFuZGxlU2V0RGF0YUF0dHIoc2V0RGF0YUF0dHIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYXR0ck1hcFtzZXREYXRhQXR0cl07XHJcbiAgICB9O1xyXG4gICAgY29uc3Qge29uRXZlbnRSZWFkeSwgZXZlbnRSZWFkeSwgcmVtb3ZlTGlzdGVuZXJ9ID0gY3JlYXRFdmVudFJlYWR5PElKc29uPigpO1xyXG5cclxuICAgIGNvbnN0IG1vZGlmeVN0YXRlID0gKFxyXG4gICAgICAgIGF0dHJzOiBzdHJpbmdbXSwgdmFsdWU6IGFueSwgc2V0RGF0YUF0dHI6IHN0cmluZywgbmV3Q29udGV4dDogSUNvbnRleHRcclxuICAgICkgPT4ge1xyXG4gICAgICAgIGxldCBkYXRhID0gc3RhdGU7XHJcbiAgICAgICAgY29uc3QgbGFzdCA9IGF0dHJzLmxlbmd0aCAtIDE7XHJcbiAgICAgICAgYXR0cnMuZm9yRWFjaCgoYXR0cjogc3RyaW5nLCBpbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChpbmRleCA9PT0gbGFzdCkge1xyXG4gICAgICAgICAgICAgICAgZGF0YVthdHRyXSA9IHZhbHVlO1xyXG4gICAgICAgICAgICAgICAgZXZlbnRSZWFkeSh7W3NldERhdGFBdHRyXTogdmFsdWV9LCBuZXdDb250ZXh0KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZGF0YVthdHRyXSA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEVycm9yIHNldERhdGE6JHtzZXREYXRhQXR0cn1gKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGRhdGEgPSBkYXRhW2F0dHJdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgc3RhdGUsXHJcbiAgICAgICAgX186IHtcclxuICAgICAgICAgICAgX2lkOiBjdXJyZW50SWQsXHJcbiAgICAgICAgICAgIF9pbmplY3RDb250ZXh0IChjdXJyZW50Q29udGV4dDogSUNvbnRleHQsIHN0b3JlVG9vbDogSUpzb24pIHtcclxuICAgICAgICAgICAgICAgIGhhY2tTZXREYXRhKGN1cnJlbnRDb250ZXh0LCBjdXJyZW50SWQsIHN0b3JlVG9vbCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBsaXN0ZW5lciA9IG9uRXZlbnRSZWFkeSgoZGF0YSwgbmV3Q29udGV4dCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Q29udGV4dC5fX3VubG9hZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyAhIOWvueW3sue7j+S4jeWGjeaYvuekuueahCBwYWdl5oiW57uE5Lu2IOWPlua2iOebkeWQrFxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVMaXN0ZW5lcihsaXN0ZW5lcik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50Q29udGV4dCAhPT0gbmV3Q29udGV4dCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyAhIOS7heWvueWFtuS7lumhtemdouaIlue7hOS7tui/m+ihjOWHuuWPkSBzZXREYXRhXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdvbkV2ZW50UmVhZHknLCBkYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RvcmVUb29sLl9uYXRpdmVTZXREYXRhLmNhbGwoY3VycmVudENvbnRleHQsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBfaGl0U3RhdGUgKHNldERhdGFBdHRyOiBzdHJpbmcsIHZhbHVlOiBhbnksIGlnbm9yZUxpc3Q6IHN0cmluZ1tdLCBuZXdDb250ZXh0OiBJQ29udGV4dCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYXR0cnMgPSBnZXRBdHRycyhzZXREYXRhQXR0cik7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBtb2RpZnlBdHRyID0gYXR0cnNbMF07XHJcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHN0YXRlW21vZGlmeUF0dHJdID09PSAndW5kZWZpbmVkJyB8fCBpZ25vcmVMaXN0LmluZGV4T2YobW9kaWZ5QXR0cikgIT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgbW9kaWZ5U3RhdGUoYXR0cnMsIHZhbHVlLCBzZXREYXRhQXR0ciwgbmV3Q29udGV4dCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbn1cclxuLy8gdG9kbyDmnInlvoXlop7liqAg5a+557uE5Lu25ZKMcGFnZeWOn+acieWxnueahOWkhOeQhiDpu5jorqTmmK9QYWdl5Lya6KaG55uWIOe7hOS7tuS8muW/veeVpVxyXG5cclxuLy8gdG9kbyDmnInlvoXmtYvor5Xnu4Tku7blsYDpg6jkvb/nlKggbWl4aW5cclxuLy8gdG9kbyDmnInlvoXmtYvor5XlpJrkuKogc3RvcmUg5Zyo5LiA5Liq57uE5Lu25oiW6ICFcGFnZeS4iueahOWcuuaZr++8jOWMheWQq+WxgOmDqCArIOWFqOWxgO+8m+WkmuS4quWxgOmDqCvlhajlsYDvvJvlpJrkuKrlsYDpg6jkuInkuKrlnLrmma9cclxuZnVuY3Rpb24gaGFja1NldERhdGEgKGNvbnRleHQ6IElDb250ZXh0LCBzdG9yZUlkOiBudW1iZXIsIHN0b3JlVG9vbDogSUpzb24pIHtcclxuICAgIGNvbnN0IG5hdGl2ZVNldERhdGEgPSBjb250ZXh0LnNldERhdGE7XHJcbiAgICAvLyAhIF9zZXREYXRhTGlzdCDpnIDopoHmjILlnKggY29udGV4dOS4iuiAjOS4jeiDveaMguWcqHN0b3JlVG9vbOS4iiDlm6DkuLrmr4/mrKFvbmxvYWTlh7rmnaXnmoTpg73mmK/kuIDkuKrmlrDnmoRjb250ZXh0XHJcbiAgICAvLyAhIOiAjCBzdG9yZVRvb2wg5piv5ZCM5LiA5LiqXHJcbiAgICBpZiAoIWNvbnRleHQuX3NldERhdGFMaXN0KSB7XHJcbiAgICAgICAgY29udGV4dC5fc2V0RGF0YUxpc3QgPSBbXTtcclxuICAgICAgICBzdG9yZVRvb2wuX25hdGl2ZVNldERhdGEgPSBuYXRpdmVTZXREYXRhO1xyXG4gICAgICAgIGNvbnRleHQuc2V0RGF0YSA9IChkYXRhLCBjYWxsYmFjaykgPT4ge1xyXG4gICAgICAgICAgICBjb250ZXh0Ll9zZXREYXRhTGlzdC5mb3JFYWNoKChmbjogRnVuY3Rpb24pID0+IGZuKGRhdGEpKTtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ25hdGl2ZVNldERhdGEuY2FsbChjb250ZXh0LCBkYXRhLCBjYWxsYmFjayk7JywgZGF0YSk7XHJcbiAgICAgICAgICAgIHJldHVybiBuYXRpdmVTZXREYXRhLmNhbGwoY29udGV4dCwgZGF0YSwgY2FsbGJhY2spO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbiAgICBjb250ZXh0Ll9zZXREYXRhTGlzdC5wdXNoKChkYXRhOiBJSnNvbikgPT4ge1xyXG4gICAgICAgIGNvbnN0IHtzdG9yZSwgaWdub3JlTGlzdH0gPSBzdG9yZVRvb2wuX3N0b3JlW3N0b3JlSWRdO1xyXG4gICAgICAgIGZvciAoY29uc3QgayBpbiBkYXRhKSB7XHJcbiAgICAgICAgICAgIHN0b3JlLl9fLl9oaXRTdGF0ZShrLCBkYXRhW2tdLCBpZ25vcmVMaXN0LCBjb250ZXh0KTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlU2V0RGF0YUF0dHIgKGF0dHI6IHN0cmluZykge1xyXG4gICAgYXR0ciA9IGF0dHIucmVwbGFjZSgvXFxbL2csICcuJykucmVwbGFjZSgvXFxdL2csICcnKTtcclxuICAgIHJldHVybiBhdHRyLnNwbGl0KCcuJyk7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaW5pdFN0b3JlSGFja2VyICh7XHJcbiAgICBvcHRpb25zLFxyXG4gICAgdHlwZSxcclxuICAgIHN0b3JlVG9vbCxcclxufToge1xyXG4gICAgb3B0aW9uczogSVBhZ2VPcHRpb247XHJcbiAgICB0eXBlOiBUQVJHRVRfVFlQRTtcclxuICAgIHN0b3JlVG9vbDogSUpzb247XHJcbn0pIHtcclxuICAgIGNvbnN0IHN0b3JlcyA9IHN0b3JlVG9vbC5fc3RvcmU7XHJcbiAgICBpZiAoc3RvcmVzKSB7XHJcbiAgICAgICAgZm9yIChjb25zdCBrIGluIHN0b3Jlcykge1xyXG4gICAgICAgICAgICBoYW5kbGVTdG9yZSh7XHJcbiAgICAgICAgICAgICAgICBvcHRpb25zLFxyXG4gICAgICAgICAgICAgICAgc3RvcmU6IHN0b3Jlc1trXS5zdG9yZSxcclxuICAgICAgICAgICAgICAgIHR5cGUsXHJcbiAgICAgICAgICAgICAgICBzdG9yZVRvb2xcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiByZWFkT25sb2FkTGlmZVRpbWUgKG9wdGlvbnM6IElQYWdlT3B0aW9uIHwgSUNvbXBvbmVudE9wdGlvbiwgdHlwZTogVEFSR0VUX1RZUEUpIHtcclxuICAgIGlmICh0eXBlID09PSBUQVJHRVRfVFlQRS5QQUdFKSB7XHJcbiAgICAgICAgcmV0dXJuIG9wdGlvbnMub25Mb2FkO1xyXG4gICAgfSBlbHNlIGlmICh0eXBlID09PSBUQVJHRVRfVFlQRS5DT01QT05FTlQpIHtcclxuICAgICAgICBpZiAob3B0aW9ucy5saWZldGltZXMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnMubGlmZXRpbWVzLmF0dGFjaGVkOyAvLyDkvb/nlKhhdHRhY2hlZCDogIzkuI3kvb/nlKggY3JlYXRlZO+8jOWboOS4umNyZWF0ZWTkuK3kuI3lj6/kvb/nlKhzZXREYXRhXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHdyaXRlT25sb2FkTGlmZVRpbWUgKFxyXG4gICAgb3B0aW9uczogSVBhZ2VPcHRpb24gfCBJQ29tcG9uZW50T3B0aW9uLFxyXG4gICAgdHlwZTogVEFSR0VUX1RZUEUsXHJcbiAgICBmdW5jOiAodGhpczogSUNvbnRleHQpID0+IHZvaWRcclxuKSB7XHJcbiAgICBpZiAodHlwZSA9PT0gVEFSR0VUX1RZUEUuUEFHRSkge1xyXG4gICAgICAgIG9wdGlvbnMub25Mb2FkID0gZnVuYztcclxuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gVEFSR0VUX1RZUEUuQ09NUE9ORU5UKSB7XHJcbiAgICAgICAgaWYgKCFvcHRpb25zLmxpZmV0aW1lcykge29wdGlvbnMubGlmZXRpbWVzID0ge307fVxyXG4gICAgICAgIG9wdGlvbnMubGlmZXRpbWVzLmF0dGFjaGVkID0gZnVuYztcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlU3RvcmUgKHtcclxuICAgIG9wdGlvbnMsXHJcbiAgICBzdG9yZSxcclxuICAgIHR5cGUsXHJcbiAgICBzdG9yZVRvb2wsXHJcbn06IHtcclxuICAgIG9wdGlvbnM6IElQYWdlT3B0aW9uIHwgSUNvbXBvbmVudE9wdGlvbjtcclxuICAgIHN0b3JlOiBJU3RvcmU7XHJcbiAgICB0eXBlOiBUQVJHRVRfVFlQRTtcclxuICAgIHN0b3JlVG9vbDogSUpzb247XHJcbn0pIHtcclxuICAgIGlmICghc3RvcmUpIHJldHVybjtcclxuICAgIGNvbnN0IHNldERhdGFIYWNrZXIgPSBmdW5jdGlvbiAodGhpczogSUNvbnRleHQpIHtcclxuICAgICAgICBzdG9yZS5fXy5faW5qZWN0Q29udGV4dCh0aGlzLCBzdG9yZVRvb2wpO1xyXG4gICAgfTtcclxuICAgIGNvbnN0IG5hdGl2ZU9uTG9hZCA9IHJlYWRPbmxvYWRMaWZlVGltZShvcHRpb25zLCB0eXBlKTtcclxuICAgIGlmICghbmF0aXZlT25Mb2FkKSB7IC8vIOWKq+aMgW9uTG9hZOadpeazqOWFpXNldERhdGFcclxuICAgICAgICB3cml0ZU9ubG9hZExpZmVUaW1lKG9wdGlvbnMsIHR5cGUsIHNldERhdGFIYWNrZXIpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAoIXN0b3JlVG9vbC5fb25Mb2FkTGlzdCkge1xyXG4gICAgICAgICAgICBzdG9yZVRvb2wuX29uTG9hZExpc3QgPSBbXTtcclxuICAgICAgICAgICAgY29uc3Qgb25Mb2FkSGFja2VyID0gZnVuY3Rpb24gKHRoaXM6IElDb250ZXh0LCAuLi5hcmdzOiBhbnlbXSkge1xyXG4gICAgICAgICAgICAgICAgc3RvcmVUb29sLl9vbkxvYWRMaXN0LmZvckVhY2goKGZuOiAodGhpczogSUNvbnRleHQpID0+IHZvaWQpID0+IGZuLmNhbGwodGhpcykpO1xyXG4gICAgICAgICAgICAgICAgbmF0aXZlT25Mb2FkLmFwcGx5KHRoaXMsIGFyZ3MpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB3cml0ZU9ubG9hZExpZmVUaW1lKG9wdGlvbnMsIHR5cGUsIG9uTG9hZEhhY2tlcik7XHJcbiAgICAgICAgfVxyXG4gIFxyXG4gICAgICAgIHN0b3JlVG9vbC5fb25Mb2FkTGlzdC5wdXNoKHNldERhdGFIYWNrZXIpO1xyXG4gICAgfVxyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiBfaW5pdEdsb2JhbFN0b3JlIChzdGF0ZTogSUpzb24gfCBJU3RvcmUpIHtcclxuICAgIGdsb2JhbFN0b3JlID0gKCghc3RhdGUuX18pID8gX2NyZWF0ZVN0b3JlKHN0YXRlKSA6IHN0YXRlKSBhcyBJU3RvcmU7XHJcbiAgICByZXR1cm4gZ2xvYmFsU3RvcmU7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjaGVja0dsb2JhbE1peGluU3RvcmUgKHN0b3JlPzogSUpzb24gfCBJU3RvcmUpIHtcclxuICAgIGlmICghc3RvcmUpIHJldHVybjtcclxuICAgIF9pbml0R2xvYmFsU3RvcmUoc3RvcmUpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaW5qZWN0U3RvcmUgKHtcclxuICAgIG9wdGlvbnMsXHJcbiAgICBtaXhpblN0b3JlLFxyXG4gICAgc3RvcmVUb29sLFxyXG4gICAgZ2xvYmFsID0gZmFsc2UsXHJcbn06IHtcclxuICAgIG9wdGlvbnM6IElQYWdlT3B0aW9uO1xyXG4gICAgbWl4aW5TdG9yZT86IElTdG9yZSB8IElKc29uPGFueT47XHJcbiAgICBzdG9yZVRvb2w6IElKc29uO1xyXG4gICAgZ2xvYmFsPzogYm9vbGVhbjtcclxufSkge1xyXG4gICAgaWYgKHR5cGVvZiBvcHRpb25zLmRhdGEgPT09ICd1bmRlZmluZWQnKSByZXR1cm47XHJcbiAgICBjb25zdCBzdG9yZSA9ICgoZ2xvYmFsKSA/IGdsb2JhbFN0b3JlIDogKG9wdGlvbnMuc3RvcmUgfHwgbWl4aW5TdG9yZSkpIGFzIElTdG9yZTtcclxuICAgIGlmICghc3RvcmUpIHJldHVybjtcclxuICAgIGlmICghc3RvcmVUb29sLl9zdG9yZSkge3N0b3JlVG9vbC5fc3RvcmUgPSB7fTt9O1xyXG4gICAgc3RvcmVUb29sLl9zdG9yZVtzdG9yZS5fXy5faWRdID0ge1xyXG4gICAgICAgIHN0b3JlLFxyXG4gICAgICAgIGlnbm9yZUxpc3Q6IG1hcFRvVGFyZ2V0KHtcclxuICAgICAgICAgICAgZGF0YTogc3RvcmUuc3RhdGUsXHJcbiAgICAgICAgICAgIHRhcmdldDogb3B0aW9ucy5kYXRhXHJcbiAgICAgICAgfSlcclxuICAgIH07XHJcbn0iXX0=