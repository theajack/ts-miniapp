"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.injectStore = exports.checkGlobalMixinStore = exports._initGlobalStore = exports.initStoreHacker = exports._createStore = void 0;
var util_1 = require("./util");
var globalStore;
var storeId = 0;
function _createStore(state) {
    var currentId = ++storeId;
    var attrMap = {};
    var getAttrs = function (setDataAttr) {
        if (!attrMap[setDataAttr]) {
            attrMap[setDataAttr] = handleSetDataAttr(setDataAttr);
        }
        return attrMap[setDataAttr];
    };
    var _a = util_1.creatEventReady(), onEventReady = _a.onEventReady, eventReady = _a.eventReady;
    var modifyState = function (attrs, value, setDataAttr) {
        var data = state;
        var last = attrs.length - 1;
        attrs.forEach(function (attr, index) {
            var _a;
            if (index === last) {
                data[attr] = value;
                eventReady((_a = {}, _a[setDataAttr] = value, _a));
            }
            else {
                if (typeof data[attr] === 'undefined') {
                    throw new Error("Error setData:" + setDataAttr);
                }
                data = data[attr];
            }
        });
    };
    return {
        state: state,
        __: {
            _id: currentId,
            _injectContext: function (currentContext, storeTool) {
                if (storeTool._store[currentId].inited) {
                    return;
                }
                storeTool._context = currentContext;
                storeTool._store[currentId].inited = true;
                hackSetData(currentContext, currentId, storeTool);
                onEventReady(function (data) {
                    storeTool._nativeSetData.call(currentContext, data);
                });
            },
            _hitState: function (setDataAttr, value, ignoreList) {
                var attrs = getAttrs(setDataAttr);
                var modifyAttr = attrs[0];
                if (typeof state[modifyAttr] === 'undefined' || ignoreList.indexOf(modifyAttr) !== -1) {
                    return false;
                }
                modifyState(attrs, value, setDataAttr);
                return true;
            }
        }
    };
}
exports._createStore = _createStore;
function hackSetData(context, storeId, storeTool) {
    var nativeSetData = context.setData;
    if (!storeTool._setDataList) {
        storeTool._setDataList = [];
        storeTool._nativeSetData = nativeSetData;
        context.setData = function (data, callback) {
            storeTool._setDataList.forEach(function (fn) { return fn(data); });
            return nativeSetData.call(context, data, callback);
        };
    }
    storeTool._setDataList.push(function (data) {
        var _a = storeTool._store[storeId], store = _a.store, ignoreList = _a.ignoreList;
        for (var k in data) {
            store.__._hitState(k, data[k], ignoreList);
        }
    });
}
function handleSetDataAttr(attr) {
    attr = attr.replace(/\[/g, '.').replace(/\]/g, '');
    return attr.split('.');
}
function initStoreHacker(_a) {
    var options = _a.options, type = _a.type, storeTool = _a.storeTool;
    var stores = storeTool._store;
    if (stores) {
        for (var k in stores) {
            handleStore({
                options: options,
                store: stores[k].store,
                type: type,
                storeTool: storeTool
            });
        }
    }
}
exports.initStoreHacker = initStoreHacker;
function readOnloadLifeTime(options, type) {
    if (type === 0) {
        return options.onLoad;
    }
    else if (type === 1) {
        if (options.lifetimes) {
            return options.lifetimes.attached;
        }
    }
    return null;
}
function writeOnloadLifeTime(options, type, func) {
    if (type === 0) {
        options.onLoad = func;
    }
    else if (type === 1) {
        if (!options.lifetimes) {
            options.lifetimes = {};
        }
        options.lifetimes.attached = func;
    }
}
function handleStore(_a) {
    var options = _a.options, store = _a.store, type = _a.type, storeTool = _a.storeTool;
    if (!store)
        return;
    var setDataHacker = function () {
        store.__._injectContext(this, storeTool);
    };
    var nativeOnLoad = readOnloadLifeTime(options, type);
    if (!nativeOnLoad) {
        writeOnloadLifeTime(options, type, setDataHacker);
    }
    else {
        if (!storeTool._onLoadList) {
            storeTool._onLoadList = [];
            var onLoadHacker = function () {
                var _this = this;
                var args = [];
                for (var _i = 0; _i < arguments.length; _i++) {
                    args[_i] = arguments[_i];
                }
                storeTool._onLoadList.forEach(function (fn) { return fn.call(_this); });
                nativeOnLoad.apply(this, args);
            };
            writeOnloadLifeTime(options, type, onLoadHacker);
        }
        storeTool._onLoadList.push(setDataHacker);
    }
}
function _initGlobalStore(state) {
    globalStore = ((!state.__) ? _createStore(state) : state);
    return globalStore;
}
exports._initGlobalStore = _initGlobalStore;
function checkGlobalMixinStore(store) {
    if (!store)
        return;
    _initGlobalStore(store);
}
exports.checkGlobalMixinStore = checkGlobalMixinStore;
function injectStore(_a) {
    var options = _a.options, mixinStore = _a.mixinStore, storeTool = _a.storeTool, _b = _a.global, global = _b === void 0 ? false : _b;
    var store = ((global) ? globalStore : (options.store || mixinStore));
    if (!store)
        return;
    if (!storeTool._store) {
        storeTool._store = {};
    }
    ;
    storeTool._store[store.__._id] = {
        store: store,
        ignoreList: util_1.mapToTarget({
            data: store.state,
            target: options.data
        })
    };
}
exports.injectStore = injectStore;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzdG9yZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFXQSwrQkFBb0Q7QUFFcEQsSUFBSSxXQUFtQixDQUFDO0FBQ3hCLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQztBQUNoQixTQUFnQixZQUFZLENBQUUsS0FBWTtJQUN0QyxJQUFNLFNBQVMsR0FBRyxFQUFFLE9BQU8sQ0FBQztJQUU1QixJQUFNLE9BQU8sR0FBb0IsRUFBRSxDQUFDO0lBQ3BDLElBQU0sUUFBUSxHQUFHLFVBQUMsV0FBbUI7UUFDakMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsRUFBRTtZQUN2QixPQUFPLENBQUMsV0FBVyxDQUFDLEdBQUcsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7U0FDekQ7UUFDRCxPQUFPLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNoQyxDQUFDLENBQUM7SUFDSSxJQUFBLEtBQTZCLHNCQUFlLEVBQVMsRUFBcEQsWUFBWSxrQkFBQSxFQUFFLFVBQVUsZ0JBQTRCLENBQUM7SUFFNUQsSUFBTSxXQUFXLEdBQUcsVUFDaEIsS0FBZSxFQUFFLEtBQVUsRUFBRSxXQUFtQjtRQUVoRCxJQUFJLElBQUksR0FBRyxLQUFLLENBQUM7UUFDakIsSUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFDOUIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFDLElBQVksRUFBRSxLQUFhOztZQUN0QyxJQUFJLEtBQUssS0FBSyxJQUFJLEVBQUU7Z0JBQ2hCLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUM7Z0JBQ25CLFVBQVUsV0FBRSxHQUFDLFdBQVcsSUFBRyxLQUFLLE1BQUUsQ0FBQzthQUN0QztpQkFBTTtnQkFDSCxJQUFJLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLFdBQVcsRUFBRTtvQkFDbkMsTUFBTSxJQUFJLEtBQUssQ0FB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LENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFXLENBQUM7SUFDcEUsT0FBTyxXQUFXLENBQUM7QUFDdkIsQ0FBQztBQUhELDRDQUdDO0FBRUQsU0FBZ0IscUJBQXFCLENBQUUsS0FBc0I7SUFDekQsSUFBSSxDQUFDLEtBQUs7UUFBRSxPQUFPO0lBQ25CLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQzVCLENBQUM7QUFIRCxzREFHQztBQUVELFNBQWdCLFdBQVcsQ0FBRSxFQVU1QjtRQVRHLE9BQU8sYUFBQSxFQUNQLFVBQVUsZ0JBQUEsRUFDVixTQUFTLGVBQUEsRUFDVCxjQUFjLEVBQWQsTUFBTSxtQkFBRyxLQUFLLEtBQUE7SUFPZCxJQUFNLEtBQUssR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxJQUFJLFVBQVUsQ0FBQyxDQUFXLENBQUM7SUFDakYsSUFBSSxDQUFDLEtBQUs7UUFBRSxPQUFPO0lBQ25CLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFO1FBQUMsU0FBUyxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUM7S0FBQztJQUFBLENBQUM7SUFDaEQsU0FBUyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHO1FBQzdCLEtBQUssT0FBQTtRQUNMLFVBQVUsRUFBRSxrQkFBVyxDQUFDO1lBQ3BCLElBQUksRUFBRSxLQUFLLENBQUMsS0FBSztZQUNqQixNQUFNLEVBQUUsT0FBTyxDQUFDLElBQUk7U0FDdkIsQ0FBQztLQUNMLENBQUM7QUFDTixDQUFDO0FBckJELGtDQXFCQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIEBBdXRob3I6IHRhY2tjaGVuXHJcbiAqIEBEYXRlOiAyMDIxLTA1LTAxIDIwOjI5OjQ3XHJcbiAqIEBMYXN0RWRpdG9yczogdGhlYWphY2tcclxuICogQExhc3RFZGl0VGltZTogMjAyMS0wNS0xMSAyMjozOTo1MFxyXG4gKiBARmlsZVBhdGg6IFxcbXAtbWl4aW5cXHNyY1xcc3RvcmUudHNcclxuICogQERlc2NyaXB0aW9uOiDnirbmgIHlhbHkuqtcclxuICovXHJcblxyXG5pbXBvcnQge1RBUkdFVF9UWVBFfSBmcm9tICcuL2NvbnN0YW50JztcclxuaW1wb3J0IHtJQ29tcG9uZW50T3B0aW9uLCBJQ29udGV4dCwgSUpzb24sIElQYWdlT3B0aW9uLCBJU3RvcmV9IGZyb20gJy4vdHlwZSc7XHJcbmltcG9ydCB7bWFwVG9UYXJnZXQsIGNyZWF0RXZlbnRSZWFkeX0gZnJvbSAnLi91dGlsJztcclxuXHJcbmxldCBnbG9iYWxTdG9yZTogSVN0b3JlO1xyXG5sZXQgc3RvcmVJZCA9IDA7XHJcbmV4cG9ydCBmdW5jdGlvbiBfY3JlYXRlU3RvcmUgKHN0YXRlOiBJSnNvbik6IElTdG9yZSB7XHJcbiAgICBjb25zdCBjdXJyZW50SWQgPSArK3N0b3JlSWQ7XHJcbiAgICAvLyDnvJPlrZhzZXREYXRhIGtleVxyXG4gICAgY29uc3QgYXR0ck1hcDogSUpzb248c3RyaW5nW10+ID0ge307XHJcbiAgICBjb25zdCBnZXRBdHRycyA9IChzZXREYXRhQXR0cjogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgaWYgKCFhdHRyTWFwW3NldERhdGFBdHRyXSkge1xyXG4gICAgICAgICAgICBhdHRyTWFwW3NldERhdGFBdHRyXSA9IGhhbmRsZVNldERhdGFBdHRyKHNldERhdGFBdHRyKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGF0dHJNYXBbc2V0RGF0YUF0dHJdO1xyXG4gICAgfTtcclxuICAgIGNvbnN0IHtvbkV2ZW50UmVhZHksIGV2ZW50UmVhZHl9ID0gY3JlYXRFdmVudFJlYWR5PElKc29uPigpO1xyXG5cclxuICAgIGNvbnN0IG1vZGlmeVN0YXRlID0gKFxyXG4gICAgICAgIGF0dHJzOiBzdHJpbmdbXSwgdmFsdWU6IGFueSwgc2V0RGF0YUF0dHI6IHN0cmluZ1xyXG4gICAgKSA9PiB7XHJcbiAgICAgICAgbGV0IGRhdGEgPSBzdGF0ZTtcclxuICAgICAgICBjb25zdCBsYXN0ID0gYXR0cnMubGVuZ3RoIC0gMTtcclxuICAgICAgICBhdHRycy5mb3JFYWNoKChhdHRyOiBzdHJpbmcsIGluZGV4OiBudW1iZXIpID0+IHtcclxuICAgICAgICAgICAgaWYgKGluZGV4ID09PSBsYXN0KSB7XHJcbiAgICAgICAgICAgICAgICBkYXRhW2F0dHJdID0gdmFsdWU7XHJcbiAgICAgICAgICAgICAgICBldmVudFJlYWR5KHtbc2V0RGF0YUF0dHJdOiB2YWx1ZX0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkYXRhW2F0dHJdID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRXJyb3Igc2V0RGF0YToke3NldERhdGFBdHRyfWApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZGF0YSA9IGRhdGFbYXR0cl07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBzdGF0ZSxcclxuICAgICAgICBfXzoge1xyXG4gICAgICAgICAgICBfaWQ6IGN1cnJlbnRJZCxcclxuICAgICAgICAgICAgX2luamVjdENvbnRleHQgKGN1cnJlbnRDb250ZXh0OiBJQ29udGV4dCwgc3RvcmVUb29sOiBJSnNvbikge1xyXG4gICAgICAgICAgICAgICAgaWYgKHN0b3JlVG9vbC5fc3RvcmVbY3VycmVudElkXS5pbml0ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBzdG9yZVRvb2wuX2NvbnRleHQgPSBjdXJyZW50Q29udGV4dDtcclxuICAgICAgICAgICAgICAgIHN0b3JlVG9vbC5fc3RvcmVbY3VycmVudElkXS5pbml0ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgaGFja1NldERhdGEoY3VycmVudENvbnRleHQsIGN1cnJlbnRJZCwgc3RvcmVUb29sKTtcclxuICAgICAgICAgICAgICAgIG9uRXZlbnRSZWFkeSgoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHN0b3JlVG9vbC5fbmF0aXZlU2V0RGF0YS5jYWxsKGN1cnJlbnRDb250ZXh0LCBkYXRhKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBfaGl0U3RhdGUgKHNldERhdGFBdHRyOiBzdHJpbmcsIHZhbHVlOiBhbnksIGlnbm9yZUxpc3Q6IHN0cmluZ1tdKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhdHRycyA9IGdldEF0dHJzKHNldERhdGFBdHRyKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG1vZGlmeUF0dHIgPSBhdHRyc1swXTtcclxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc3RhdGVbbW9kaWZ5QXR0cl0gPT09ICd1bmRlZmluZWQnIHx8IGlnbm9yZUxpc3QuaW5kZXhPZihtb2RpZnlBdHRyKSAhPT0gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBtb2RpZnlTdGF0ZShhdHRycywgdmFsdWUsIHNldERhdGFBdHRyKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxufVxyXG5cclxuZnVuY3Rpb24gaGFja1NldERhdGEgKGNvbnRleHQ6IElDb250ZXh0LCBzdG9yZUlkOiBudW1iZXIsIHN0b3JlVG9vbDogSUpzb24pIHtcclxuICAgIGNvbnN0IG5hdGl2ZVNldERhdGEgPSBjb250ZXh0LnNldERhdGE7XHJcbiAgICBpZiAoIXN0b3JlVG9vbC5fc2V0RGF0YUxpc3QpIHtcclxuICAgICAgICBzdG9yZVRvb2wuX3NldERhdGFMaXN0ID0gW107XHJcbiAgICAgICAgc3RvcmVUb29sLl9uYXRpdmVTZXREYXRhID0gbmF0aXZlU2V0RGF0YTtcclxuICAgICAgICBjb250ZXh0LnNldERhdGEgPSAoZGF0YSwgY2FsbGJhY2spID0+IHtcclxuICAgICAgICAgICAgc3RvcmVUb29sLl9zZXREYXRhTGlzdC5mb3JFYWNoKChmbjogRnVuY3Rpb24pID0+IGZuKGRhdGEpKTtcclxuICAgICAgICAgICAgcmV0dXJuIG5hdGl2ZVNldERhdGEuY2FsbChjb250ZXh0LCBkYXRhLCBjYWxsYmFjayk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIHN0b3JlVG9vbC5fc2V0RGF0YUxpc3QucHVzaCgoZGF0YTogSUpzb24pID0+IHtcclxuICAgICAgICBjb25zdCB7c3RvcmUsIGlnbm9yZUxpc3R9ID0gc3RvcmVUb29sLl9zdG9yZVtzdG9yZUlkXTtcclxuICAgICAgICBmb3IgKGNvbnN0IGsgaW4gZGF0YSkge1xyXG4gICAgICAgICAgICBzdG9yZS5fXy5faGl0U3RhdGUoaywgZGF0YVtrXSwgaWdub3JlTGlzdCk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZVNldERhdGFBdHRyIChhdHRyOiBzdHJpbmcpIHtcclxuICAgIGF0dHIgPSBhdHRyLnJlcGxhY2UoL1xcWy9nLCAnLicpLnJlcGxhY2UoL1xcXS9nLCAnJyk7XHJcbiAgICByZXR1cm4gYXR0ci5zcGxpdCgnLicpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaW5pdFN0b3JlSGFja2VyICh7XHJcbiAgICBvcHRpb25zLFxyXG4gICAgdHlwZSxcclxuICAgIHN0b3JlVG9vbCxcclxufToge1xyXG4gICAgb3B0aW9uczogSVBhZ2VPcHRpb247XHJcbiAgICB0eXBlOiBUQVJHRVRfVFlQRTtcclxuICAgIHN0b3JlVG9vbDogSUpzb247XHJcbn0pIHtcclxuICAgIGNvbnN0IHN0b3JlcyA9IHN0b3JlVG9vbC5fc3RvcmU7XHJcbiAgICBpZiAoc3RvcmVzKSB7XHJcbiAgICAgICAgZm9yIChjb25zdCBrIGluIHN0b3Jlcykge1xyXG4gICAgICAgICAgICBoYW5kbGVTdG9yZSh7XHJcbiAgICAgICAgICAgICAgICBvcHRpb25zLFxyXG4gICAgICAgICAgICAgICAgc3RvcmU6IHN0b3Jlc1trXS5zdG9yZSxcclxuICAgICAgICAgICAgICAgIHR5cGUsXHJcbiAgICAgICAgICAgICAgICBzdG9yZVRvb2xcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiByZWFkT25sb2FkTGlmZVRpbWUgKG9wdGlvbnM6IElQYWdlT3B0aW9uIHwgSUNvbXBvbmVudE9wdGlvbiwgdHlwZTogVEFSR0VUX1RZUEUpIHtcclxuICAgIGlmICh0eXBlID09PSBUQVJHRVRfVFlQRS5QQUdFKSB7XHJcbiAgICAgICAgcmV0dXJuIG9wdGlvbnMub25Mb2FkO1xyXG4gICAgfSBlbHNlIGlmICh0eXBlID09PSBUQVJHRVRfVFlQRS5DT01QT05FTlQpIHtcclxuICAgICAgICBpZiAob3B0aW9ucy5saWZldGltZXMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnMubGlmZXRpbWVzLmF0dGFjaGVkOyAvLyDkvb/nlKhhdHRhY2hlZCDogIzkuI3kvb/nlKggY3JlYXRlZO+8jOWboOS4umNyZWF0ZWTkuK3kuI3lj6/kvb/nlKhzZXREYXRhXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHdyaXRlT25sb2FkTGlmZVRpbWUgKFxyXG4gICAgb3B0aW9uczogSVBhZ2VPcHRpb24gfCBJQ29tcG9uZW50T3B0aW9uLFxyXG4gICAgdHlwZTogVEFSR0VUX1RZUEUsXHJcbiAgICBmdW5jOiAodGhpczogSUNvbnRleHQpID0+IHZvaWRcclxuKSB7XHJcbiAgICBpZiAodHlwZSA9PT0gVEFSR0VUX1RZUEUuUEFHRSkge1xyXG4gICAgICAgIG9wdGlvbnMub25Mb2FkID0gZnVuYztcclxuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gVEFSR0VUX1RZUEUuQ09NUE9ORU5UKSB7XHJcbiAgICAgICAgaWYgKCFvcHRpb25zLmxpZmV0aW1lcykge29wdGlvbnMubGlmZXRpbWVzID0ge307fVxyXG4gICAgICAgIG9wdGlvbnMubGlmZXRpbWVzLmF0dGFjaGVkID0gZnVuYztcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlU3RvcmUgKHtcclxuICAgIG9wdGlvbnMsXHJcbiAgICBzdG9yZSxcclxuICAgIHR5cGUsXHJcbiAgICBzdG9yZVRvb2wsXHJcbn06IHtcclxuICAgIG9wdGlvbnM6IElQYWdlT3B0aW9uIHwgSUNvbXBvbmVudE9wdGlvbjtcclxuICAgIHN0b3JlOiBJU3RvcmU7XHJcbiAgICB0eXBlOiBUQVJHRVRfVFlQRTtcclxuICAgIHN0b3JlVG9vbDogSUpzb247XHJcbn0pIHtcclxuICAgIGlmICghc3RvcmUpIHJldHVybjtcclxuICAgIGNvbnN0IHNldERhdGFIYWNrZXIgPSBmdW5jdGlvbiAodGhpczogSUNvbnRleHQpIHtcclxuICAgICAgICBzdG9yZS5fXy5faW5qZWN0Q29udGV4dCh0aGlzLCBzdG9yZVRvb2wpO1xyXG4gICAgfTtcclxuICAgIGNvbnN0IG5hdGl2ZU9uTG9hZCA9IHJlYWRPbmxvYWRMaWZlVGltZShvcHRpb25zLCB0eXBlKTtcclxuICAgIGlmICghbmF0aXZlT25Mb2FkKSB7IC8vIOWKq+aMgW9uTG9hZOadpeazqOWFpXNldERhdGFcclxuICAgICAgICB3cml0ZU9ubG9hZExpZmVUaW1lKG9wdGlvbnMsIHR5cGUsIHNldERhdGFIYWNrZXIpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAoIXN0b3JlVG9vbC5fb25Mb2FkTGlzdCkge1xyXG4gICAgICAgICAgICBzdG9yZVRvb2wuX29uTG9hZExpc3QgPSBbXTtcclxuICAgICAgICAgICAgY29uc3Qgb25Mb2FkSGFja2VyID0gZnVuY3Rpb24gKHRoaXM6IElDb250ZXh0LCAuLi5hcmdzOiBhbnlbXSkge1xyXG4gICAgICAgICAgICAgICAgc3RvcmVUb29sLl9vbkxvYWRMaXN0LmZvckVhY2goKGZuOiAodGhpczogSUNvbnRleHQpID0+IHZvaWQpID0+IGZuLmNhbGwodGhpcykpO1xyXG4gICAgICAgICAgICAgICAgbmF0aXZlT25Mb2FkLmFwcGx5KHRoaXMsIGFyZ3MpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB3cml0ZU9ubG9hZExpZmVUaW1lKG9wdGlvbnMsIHR5cGUsIG9uTG9hZEhhY2tlcik7XHJcbiAgICAgICAgfVxyXG4gIFxyXG4gICAgICAgIHN0b3JlVG9vbC5fb25Mb2FkTGlzdC5wdXNoKHNldERhdGFIYWNrZXIpO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gX2luaXRHbG9iYWxTdG9yZSAoc3RhdGU6IElKc29uIHwgSVN0b3JlKSB7XHJcbiAgICBnbG9iYWxTdG9yZSA9ICgoIXN0YXRlLl9fKSA/IF9jcmVhdGVTdG9yZShzdGF0ZSkgOiBzdGF0ZSkgYXMgSVN0b3JlO1xyXG4gICAgcmV0dXJuIGdsb2JhbFN0b3JlO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY2hlY2tHbG9iYWxNaXhpblN0b3JlIChzdG9yZT86IElKc29uIHwgSVN0b3JlKSB7XHJcbiAgICBpZiAoIXN0b3JlKSByZXR1cm47XHJcbiAgICBfaW5pdEdsb2JhbFN0b3JlKHN0b3JlKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGluamVjdFN0b3JlICh7XHJcbiAgICBvcHRpb25zLFxyXG4gICAgbWl4aW5TdG9yZSxcclxuICAgIHN0b3JlVG9vbCxcclxuICAgIGdsb2JhbCA9IGZhbHNlLFxyXG59OiB7XHJcbiAgICBvcHRpb25zOiBJUGFnZU9wdGlvbjtcclxuICAgIG1peGluU3RvcmU/OiBJU3RvcmUgfCBJSnNvbjxhbnk+O1xyXG4gICAgc3RvcmVUb29sOiBJSnNvbjtcclxuICAgIGdsb2JhbD86IGJvb2xlYW47XHJcbn0pIHtcclxuICAgIGNvbnN0IHN0b3JlID0gKChnbG9iYWwpID8gZ2xvYmFsU3RvcmUgOiAob3B0aW9ucy5zdG9yZSB8fCBtaXhpblN0b3JlKSkgYXMgSVN0b3JlO1xyXG4gICAgaWYgKCFzdG9yZSkgcmV0dXJuO1xyXG4gICAgaWYgKCFzdG9yZVRvb2wuX3N0b3JlKSB7c3RvcmVUb29sLl9zdG9yZSA9IHt9O307XHJcbiAgICBzdG9yZVRvb2wuX3N0b3JlW3N0b3JlLl9fLl9pZF0gPSB7XHJcbiAgICAgICAgc3RvcmUsXHJcbiAgICAgICAgaWdub3JlTGlzdDogbWFwVG9UYXJnZXQoe1xyXG4gICAgICAgICAgICBkYXRhOiBzdG9yZS5zdGF0ZSxcclxuICAgICAgICAgICAgdGFyZ2V0OiBvcHRpb25zLmRhdGFcclxuICAgICAgICB9KVxyXG4gICAgfTtcclxufSJdfQ==